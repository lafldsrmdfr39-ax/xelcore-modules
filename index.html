<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. | CHRONOS (G-SYNC)</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        /* ESTÉTICA AXEL / JARVIS */
        :root {
            --amber: #ffb300; --amber-dim: rgba(255, 179, 0, 0.1); --bg: #050505;
            --line: rgba(255, 179, 0, 0.15); --now-color: #ff3333;
            /* Colores de Google Calendar mapeados a neón */
            --cal-blue: rgba(66, 133, 244, 0.3); --cal-blue-b: #4285F4;
            --cal-green: rgba(52, 168, 83, 0.3); --cal-green-b: #34A853;
            --cal-default: rgba(255, 179, 0, 0.2); --cal-default-b: #ffb300;
        }
        body { background-color: var(--bg); color: var(--amber); font-family: 'Share Tech Mono', monospace; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER */
        .header { padding: 15px 25px; border-bottom: 1px solid var(--amber-dim); display: flex; justify-content: space-between; align-items: center; background: rgba(20,10,0,0.5); z-index: 100; }
        .title-group h1 { margin: 0; font-size: 24px; letter-spacing: 4px; }
        .status-badge { font-size: 10px; border: 1px solid var(--amber); padding: 2px 8px; text-transform: uppercase; cursor: pointer; transition: all 0.3s;}
        .status-badge:hover { background: var(--amber); color: #000; box-shadow: 0 0 10px var(--amber); }

        /* GRID */
        .chronos-container { flex-grow: 1; display: flex; overflow: hidden; position: relative; }
        .time-axis { width: 50px; border-right: 1px solid var(--amber-dim); display: flex; flex-direction: column; background: #080808; }
        .time-slot { height: 60px; border-bottom: 1px solid var(--line); font-size: 10px; display: flex; justify-content: center; padding-top: 5px; color: #666; }
        
        .week-grid { flex-grow: 1; display: flex; overflow-y: auto; position: relative; scrollbar-width: none; }
        .week-grid::-webkit-scrollbar { display: none; }
        
        .day-column { flex: 1; min-width: 100px; border-right: 1px solid var(--line); position: relative; background-image: linear-gradient(var(--line) 1px, transparent 1px); background-size: 100% 60px; }
        
        .week-header { display: flex; margin-left: 50px; border-bottom: 1px solid var(--amber); background: var(--bg); }
        .day-header { flex: 1; text-align: center; padding: 10px 0; font-size: 12px; border-right: 1px solid var(--line); }
        .day-header.today { background: rgba(255, 179, 0, 0.15); color: #fff; text-shadow: 0 0 5px var(--amber); }

        /* EVENTOS */
        .event-block {
            position: absolute; left: 2px; width: calc(100% - 4px); border-radius: 2px; padding: 4px;
            font-size: 10px; border-left: 3px solid; overflow: hidden; cursor: pointer; transition: all 0.2s;
            background: var(--cal-default); border-color: var(--cal-default-b);
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .event-block:hover { z-index: 50; transform: scale(1.05); box-shadow: 0 0 15px rgba(255, 179, 0, 0.4); border-color: #fff; }
        .ev-title { font-weight: bold; color: #fff; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ev-time { display: block; opacity: 0.7; font-size: 9px; margin-top: 2px; }

        /* NOW LINE */
        .now-line { position: absolute; left: 0; width: 100%; height: 2px; background: var(--now-color); z-index: 40; pointer-events: none; box-shadow: 0 0 5px red; }
        .now-marker { position: absolute; left: 0; top: -4px; width: 8px; height: 8px; background: var(--now-color); border-radius: 50%; }
    </style>
</head>
<body>

    <div class="header">
        <div class="title-group">
            <h1>CHRONOS</h1>
            <span id="date-display">SISTEMA EN ESPERA...</span>
        </div>
        <div class="status-badge" id="auth-btn" onclick="handleAuthClick()">INICIAR ENLACE GOOGLE</div>
    </div>

    <div class="week-header" id="week-header"></div>

    <div class="chronos-container">
        <div class="time-axis" id="time-axis"></div>
        <div class="week-grid" id="week-grid">
            <div class="now-line" id="now-line"><div class="now-marker"></div></div>
        </div>
    </div>

    <!-- MAIN SCRIPT (DEFINED BEFORE GOOGLE LIBS LOAD) -->
    <script>
        /* --- CREDENCIALES --- */
        const CLIENT_ID = '788733683848-7nj7snhk36fp83uv101nonk70a4rvn7e.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDlBqXPP1t1Wzr2rY7nbTdBKqGcmqCTg10'; 
        
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // --- SISTEMA GRID (JARVIS) ---
        const PIXELS_PER_HOUR = 60;
        const gridEl = document.getElementById('week-grid');
        const axisEl = document.getElementById('time-axis');
        const headerEl = document.getElementById('week-header');
        
        // Inicializar Grid Visual
        function initGrid() {
            let axisHtml = '';
            for(let i=0; i<24; i++) axisHtml += `<div class="time-slot">${i.toString().padStart(2,'0')}:00</div>`;
            axisEl.innerHTML = axisHtml;

            const days = ['DOM', 'LUN', 'MAR', 'MIE', 'JUE', 'VIE', 'SAB'];
            const today = new Date();
            const currentDayIndex = today.getDay(); 
            
            const mondayOffset = currentDayIndex === 0 ? -6 : 1 - currentDayIndex;
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() + mondayOffset);

            let headerHtml = '';
            // FIX: Usamos gridInnerHtml consistentemente
            let gridInnerHtml = `<div class="now-line" id="now-line"><div class="now-marker"></div></div>`;

            for(let i=0; i<7; i++) {
                let d = new Date(startOfWeek);
                d.setDate(startOfWeek.getDate() + i);
                const isToday = d.toDateString() === today.toDateString();
                
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const colId = `col-${year}-${month}-${day}`;

                headerHtml += `<div class="day-header ${isToday ? 'today' : ''}">
                    ${days[d.getDay()]} ${d.getDate()}
                </div>`;
                
                // FIX: Acumular en gridInnerHtml, no en una variable no definida
                gridInnerHtml += `<div class="day-column" id="${colId}" style="height:${24*PIXELS_PER_HOUR}px"></div>`;
            }
            headerEl.innerHTML = headerHtml;
            gridEl.innerHTML = gridInnerHtml;
            
            updateNowLine();
        }

        function updateNowLine() {
            const now = new Date();
            const minutes = (now.getHours() * 60) + now.getMinutes();
            const top = (minutes / 60) * PIXELS_PER_HOUR;
            const line = document.getElementById('now-line');
            if(line) line.style.top = `${top}px`;
            
            // Auto scroll inicial
            if(!window.scrolled) {
                gridEl.scrollTo({ top: top - 300, behavior: 'smooth' });
                window.scrolled = true;
            }
        }

        // --- GOOGLE API LOGIC (Global Scope) ---
        // Definidas en window para que el onload del script externo las encuentre
        window.gapiLoaded = function() {
            gapi.load('client', async () => {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
                gapiInited = true;
                maybeEnableButtons();
            });
        }

        window.gisLoaded = function() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // Definido en click
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('auth-btn').innerText = "CONECTAR CALENDARIO";
                document.getElementById('auth-btn').style.borderColor = "#fff";
            }
        }

        window.handleAuthClick = function() {
            tokenClient.callback = async (resp) => {
                if (resp.error) throw resp;
                document.getElementById('auth-btn').innerText = "ENLACE SEGURO";
                document.getElementById('auth-btn').style.borderColor = "#0f0";
                document.getElementById('auth-btn').style.color = "#0f0";
                document.getElementById('auth-btn').style.boxShadow = "0 0 10px #0f0";
                await listUpcomingEvents();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        async function listUpcomingEvents() {
            document.getElementById('date-display').innerText = "DESCARGANDO MATRIZ...";
            
            const today = new Date();
            const currentDayIndex = today.getDay();
            const mondayOffset = currentDayIndex === 0 ? -6 : 1 - currentDayIndex;
            
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() + mondayOffset);
            startOfWeek.setHours(0,0,0,0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 7);

            try {
                const request = {
                    'calendarId': 'primary',
                    'timeMin': startOfWeek.toISOString(),
                    'timeMax': endOfWeek.toISOString(),
                    'showDeleted': false,
                    'singleEvents': true,
                    'orderBy': 'startTime'
                };
                
                const response = await gapi.client.calendar.events.list(request);
                const events = response.result.items;

                document.getElementById('date-display').innerText = "SISTEMA SINCRONIZADO";
                renderEvents(events);

            } catch (err) {
                document.getElementById('date-display').innerText = "FALLO DE ENLACE";
                console.error(err);
                alert("Error de conexión con Google: " + err.message);
            }
        }

        function renderEvents(events) {
            document.querySelectorAll('.event-block').forEach(e => e.remove());

            if (!events || events.length === 0) return;

            events.forEach(event => {
                let start = event.start.dateTime;
                let end = event.end.dateTime;
                
                if (!start) return; 

                const startDate = new Date(start);
                const endDate = new Date(end);
                
                const year = startDate.getFullYear();
                const month = String(startDate.getMonth() + 1).padStart(2, '0');
                const day = String(startDate.getDate()).padStart(2, '0');
                const colId = `col-${year}-${month}-${day}`;
                
                const col = document.getElementById(colId);
                
                if (col) {
                    const startMin = (startDate.getHours() * 60) + startDate.getMinutes();
                    const durationMin = (endDate - startDate) / (1000 * 60);
                    
                    const topPx = (startMin / 60) * PIXELS_PER_HOUR;
                    const heightPx = (durationMin / 60) * PIXELS_PER_HOUR;

                    const el = document.createElement('div');
                    el.className = 'event-block';
                    el.style.top = `${topPx}px`;
                    el.style.height = `${Math.max(20, heightPx)}px`;
                    
                    const timeStr = startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    el.innerHTML = `
                        <span class="ev-title">${event.summary}</span>
                        <span class="ev-time">${timeStr}</span>
                    `;
                    
                    const titleLower = event.summary.toLowerCase();
                    if (titleLower.includes('entreno') || titleLower.includes('gym')) {
                        el.style.borderColor = '#34A853'; el.style.backgroundColor = 'rgba(52, 168, 83, 0.2)';
                    } else if (titleLower.includes('trabajo') || titleLower.includes('work')) {
                        el.style.borderColor = '#4285F4'; el.style.backgroundColor = 'rgba(66, 133, 244, 0.2)';
                    } else if (titleLower.includes('estudio') || titleLower.includes('clase')) {
                        el.style.borderColor = '#A142F4'; el.style.backgroundColor = 'rgba(161, 66, 244, 0.2)';
                    }
                    
                    col.appendChild(el);
                }
            });
        }

        // Init
        initGrid();
        setInterval(updateNowLine, 60000); 

    </script>

    <!-- GOOGLE API SCRIPTS (LOAD AFTER LOGIC) -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
